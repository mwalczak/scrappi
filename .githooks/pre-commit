#!/bin/bash

# Git pre-commit hook to run code quality checks
# This ensures code quality and architectural boundaries before each commit

echo "üîç Running code quality checks..."
echo ""

# Run PHPStan static analysis first (faster, catches type errors)
echo "1/2 Running PHPStan static analysis..."
if ! ./phpstan analyse --no-progress --error-format=table; then
    echo ""
    echo "‚ùå PHPStan found type errors!"
    echo "   Please fix the errors before committing."
    echo ""
    echo "   To see detailed analysis, run: ./phpstan analyse"
    echo "   To analyze specific path: ./phpstan analyse src/Domain"
    echo "   To bypass this check (not recommended): git commit --no-verify"
    echo ""
    exit 1
fi
echo "‚úÖ PHPStan checks passed!"
echo ""

# Run Deptrac architecture checks second (ensures layering)
echo "2/2 Running Deptrac architecture checks..."
if ! ./deptrac analyze --config-file=deptrac.yaml --no-progress; then
    echo ""
    echo "‚ùå Deptrac found architectural violations!"
    echo "   Please fix the violations before committing."
    echo ""
    echo "   To see detailed violations, run: ./deptrac analyze"
    echo "   To bypass this check (not recommended): git commit --no-verify"
    echo ""
    exit 1
fi
echo "‚úÖ Deptrac checks passed!"
echo ""

echo "‚ú® All checks passed! Proceeding with commit..."
exit 0
