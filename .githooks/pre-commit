#!/bin/bash

# Git pre-commit hook - runs quality checks before each commit
# This ensures code quality and architectural boundaries are maintained

set -e  # Exit on first error

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${BLUE}üîç Running pre-commit quality checks...${NC}"
echo ""

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}‚ùå Not a git repository${NC}"
    exit 1
fi

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}‚Ñπ No PHP files to check${NC}"
    exit 0
fi

# Run PHPStan
echo -e "${BLUE}‚Üí Running PHPStan static analysis...${NC}"
if ! ./phpstan analyse --no-progress; then
    echo ""
    echo -e "${RED}‚ùå PHPStan found errors!${NC}"
    echo "   Please fix the errors before committing."
    echo ""
    echo "   To see detailed errors, run: ${YELLOW}make phpstan${NC}"
    echo "   To bypass this check (not recommended): ${YELLOW}git commit --no-verify${NC}"
    echo ""
    exit 1
fi
echo -e "${GREEN}‚úì PHPStan passed${NC}"
echo ""

# Run Deptrac
echo -e "${BLUE}‚Üí Running Deptrac architecture validation...${NC}"
if ! ./deptrac analyze --config-file=deptrac.yaml --no-progress; then
    echo ""
    echo -e "${RED}‚ùå Deptrac found architectural violations!${NC}"
    echo "   Please fix the violations before committing."
    echo ""
    echo "   To see detailed violations, run: ${YELLOW}make deptrac${NC}"
    echo "   To bypass this check (not recommended): ${YELLOW}git commit --no-verify${NC}"
    echo ""
    exit 1
fi
echo -e "${GREEN}‚úì Deptrac passed${NC}"
echo ""

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo ""
exit 0
